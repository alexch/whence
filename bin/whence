#!/usr/bin/env ruby
here = File.dirname(File.expand_path(__FILE_))

if (%w( -h --help -help help ) & ARGV).length > 0
  puts "usage: whence [-hv]"
  puts "starts whence server in the foreground. kill with ^C"
  exit
end

if ARGV.include?('-v')
  puts "whence 1.0"
  exit
end

require 'webrick'

# todo: use Rack or Sinatra instead?

servlet = Class.new(WEBrick::HTTPServlet::AbstractServlet) do
  def do_GET(request, response)
    host    = request.path.gsub('/','')
    dotjs_dir = File.expand_path("~/.js")    
    file    = "#{dotjs_dir}/#{host}.js"
    default = "#{dotjs_dir}/default.js"

    Dir.mkdir(dotjs_dir) unless File.exist?(dotjs_dir)    
    log = "#{dotjs_dir}/wherewasi.txt"
    File.open(log, "a") do |f|
      f.puts "#{Time.now.iso8601} - #{host}"
    end

    body = ''
    body << File.read(default) + "\n" if File.exists?(default)
    body << File.read(file) if File.exists?(file)

    response.status = body.empty? ? 204 : 200
    response['Access-Control-Allow-Origin'] = '*'
    response['Content-Type'] = 'text/javascript'
    response.body = body
  end
end

server = WEBrick::HTTPServer.new(:Port => 3132)
server.mount('/', servlet)

%w( INT TERM ).each do |sig|
  trap(sig) { server.shutdown }
end

server.start
